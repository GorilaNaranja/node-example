<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <title>Chat Example</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font: 13px Helvetica, Arial;
      }
    </style>
  </head>

  <body>
    <div class="row">
      <div class="col-9">
        <div class="card m-3">
          <h3 class="card-header">CHAT</h3>
          <div class="card-body">
            <ul id="messages"></ul>
          </div>
          <div class="card-footer">
            <form class="form-inline">
              <input
                id="m"
                class="form-control"
                autocomplete="off"
                placeholder="Message"
              />
              <div class="input-group-append">
                <button class="btn btn-dark mx-3">Send</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card m-3">
          <h3 class="card-header">ONLINE</h3>
          <div class="card-body">
            <ul id="connected-users"></ul>
          </div>
          <div class="card-footer">
            <small class="text-muted">users online in this room</small>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function() {
        console.log(window.location.hostname + ":8000");

        const socket = io(window.location.hostname + ":8000");
        const room = window.location.pathname.split("/room/")[1];
        const user = { name: "Felipe", id: "123" };
        const element = '<div class="shadow p-3 mb-2 bg-white rounded">';

        socket.emit("joinRoom", room, user);
        socket.emit("requestMessages", room);

        $("form").submit(function(e) {
          e.preventDefault();
          const msg = $("#m").val();
          if (msg) socket.emit("createMsg", msg, room);
          $("#m").val("");
          return false;
        });

        socket.on("usersConnected", users => {
          $("#connected-users").empty();
          users.forEach(user => {
            $("#connected-users").append($(element).text(user.name));
          });
        });

        socket.on("createMsg", (data, roomId) => {
          const hours = new Date(data.date).getHours();
          const minutes = new Date(data.date).getMinutes();

          $("#messages").append(
            $(element).text(
              `[${hours}:${minutes}] ${data.user}: ${data.message}`
            )
          );
        });

        socket.on("loadMessages", messages => {
          messages.forEach(data => {
            const hours = new Date(data.date).getHours();
            const minutes = new Date(data.date).getMinutes();

            $("#messages").append(
              $(element).text(
                `[${hours}:${minutes}] ${data.user}: ${data.message}`
              )
            );
          });
        });
      });
    </script>
  </body>
</html>
